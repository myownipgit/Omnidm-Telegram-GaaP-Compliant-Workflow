{
  "name": "[KH.GaaS] omnidm.ai :: 06 Deliver :: Send KHQR to Telegram (v1)",
  "nodes": [
    {
      "id": "start",
      "name": "DEL: Start",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "parameters": {}
    },
    {
      "id": "format-message",
      "name": "DEL: Format Payment Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300],
      "parameters": {
        "language": "javaScript",
        "jsCode": "const intent = $json.camdx.payment_intent;\nconst khqr = $json.rail.payload.khqr;\n\nconst expiresDate = new Date(intent.expires_at);\nconst expiresFormatted = expiresDate.toLocaleString('en-GB', {\n  day: '2-digit',\n  month: '2-digit',\n  year: 'numeric',\n  hour: '2-digit',\n  minute: '2-digit',\n  hour12: true\n});\n\nconst message = `âœ… Order Confirmed!\n\nğŸ½ï¸ ${intent.transaction.description}\nğŸ’° Amount: $${intent.transaction.amount} USD\nğŸ“‹ Order ID: ${intent.intent_id}\n\nPay with KHQR:\n\\`${khqr.qr_string}\\`\n\nğŸ”— [Open Bakong](${khqr.deeplink})\n\nâ° Expires: ${expiresFormatted}\n\nğŸ‡°ğŸ‡­ Powered by Cambodia GaaP`;\n\nreturn {\n  json: {\n    ...$json,\n    delivery: {\n      chat_id: $json.commerce.request.message.chat_id,\n      message: message\n    }\n  }\n};"
      }
    },
    {
      "id": "send-telegram",
      "name": "DEL: Send to Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [680, 300],
      "parameters": {
        "resource": "message",
        "operation": "sendMessage",
        "chatId": "={{ $json.delivery.chat_id }}",
        "text": "={{ $json.delivery.message }}",
        "additionalFields": {
          "parseMode": "Markdown"
        }
      }
    },
    {
      "id": "output",
      "name": "DEL: Output",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [900, 300],
      "parameters": {}
    }
  ],
  "connections": {
    "DEL: Start": {
      "main": [[{"node": "DEL: Format Payment Message", "type": "main", "index": 0}]]
    },
    "DEL: Format Payment Message": {
      "main": [[{"node": "DEL: Send to Telegram", "type": "main", "index": 0}]]
    },
    "DEL: Send to Telegram": {
      "main": [[{"node": "DEL: Output", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
